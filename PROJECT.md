# KOSPI TOP 30 놀이 - 프로젝트 문서

## 개요
KOSPI 시가총액 상위 30종목의 월봉 종가를 조회하고, 매매 신호 기반 백테스트를 수행하는 Streamlit 웹 앱.

---

## 파일 구조

| 파일 | 역할 |
|------|------|
| `app.py` | Streamlit UI (탭 구성, 차트, 테이블) |
| `data_fetcher.py` | 데이터 수집 (종목 목록, 월봉 종가, KOSPI 지수) |
| `backtester.py` | 백테스트 엔진 (신호 생성, 개별/통합 백테스트, 성과 지표) |
| `requirements.txt` | Python 패키지 의존성 |
| `.streamlit/config.toml` | Streamlit 서버 설정 (포트, 테마, 외부 접속) |

---

## 탭 구성

### 1. 개별 백테스트
- 드롭다운으로 종목 선택
- 매매 신호 차트 (종가 + 매수/매도 마커)
- 누적수익률 비교 차트 (전략 vs KOSPI Buy&Hold)
- 성과 지표 테이블 (전략 vs 벤치마크)
- 매매 내역 테이블

### 2. 통합 백테스트
- 30종목 포트폴리오 (각 종목 1/30 고정 비중)
- 매수 신호 없는 종목은 현금 보유 (수익률 0)
- 포트폴리오 누적수익률 vs KOSPI 비교 차트
- 월별 활성 종목 수 바 차트
- 성과 비교 테이블
- 월별 수익률 히트맵

### 3. 이번달 신호
- 30종목의 현재 매수/매도 상태 한눈에 확인
- 신규 매수 신호, 신규 매도 신호, 보유 유지 분류

---

## 성과 지표
- 누적수익률 (%)
- CAGR (%)
- MDD (%)
- 샤프비율
- 승률 (%)
- 손익비

---

## 데이터 소스 (우선순위)
1. **yfinance** - 2001년~ 전체 이력 (개별종목: `.KS` 접미사, KOSPI: `^KS11`)
2. **pykrx** - 최근 ~12년
3. **FinanceDataReader** - 종목 목록 및 OHLCV

---

## 보안 기능
- 매매 규칙 난독화 (Base64 인코딩 + 비서술적 변수명)
- 앱 만료 기간 설정 (2027년부터 동작 중지)
- UI에 전략 세부 정보 노출 없음

---

## 실행 방법

### 로컬 실행
```bash
cd "C:\Users\samsung\Desktop\안티그래버티\매매"
python -m streamlit run app.py
```
- **PC**: http://localhost:8501
- **같은 WiFi 모바일**: http://<PC의 IP>:8501

### 클라우드 배포 (24시간 운영)
- **플랫폼**: Streamlit Community Cloud
- **GitHub**: https://github.com/kimyoonhagood-hub/kospi-top30-app
- **Branch**: `master` / **Main file**: `app.py`
- GitHub push 시 자동 재배포
- 비활성 시 슬립 모드 → 접속 시 자동 재시작

---

## 서버 설정 (.streamlit/config.toml)
- `address = "0.0.0.0"` : 외부 기기 접속 허용
- `enableCORS = false` : CORS 비활성화
- `enableXsrfProtection = false` : XSRF 비활성화
- `headless = true` : 브라우저 자동 열기 비활성화

---

## 모바일 최적화
- 768px 이하 화면에서 반응형 레이아웃 적용
- 컬럼 세로 배치 (100% 너비)
- 탭 터치 영역 확대 (패딩 0.5rem 0.6rem, 가로 스크롤)
- 버튼 최소 높이 44px (iOS 권장 터치 영역)
- 차트 높이 축소 (280~350px)
- 차트 좌우 마진 최소화 (l=10, r=10)
- 매수/매도 마커: 슬림한 화살표 (arrow-up/down, 10px)
- 주석 폰트 확대 (14~16px)
- Plotly 툴바: +/- 줌 버튼만 표시
- 데이터프레임/테이블 높이 축소
- 제목/본문/셀렉트박스 폰트 크기 70% 축소
- 종목 선택 드롭다운 직접 입력 비활성화 (모바일 키보드 방지)

---

## 차트 기능

### 기본 범위 설정
- 개별 백테스트: 기본 3년 표시
- 통합 백테스트: 기본 6년 표시

### 기간 조절
- **Rangeslider**: 하단 스크롤바로 좌우 이동
- **Rangeselector 버튼**: 1Y / 3Y / 6Y / 전체 기간 선택
- **+/- 버튼**: 확대/축소 (드래그 줌 비활성화)

### X축 눈금
- 주요 눈금: 6개월 간격 (`%y/%m` 형식)
- 보조 눈금: 1개월 간격 (점선 그리드)

### 매수/매도 마커
- 슬림한 화살표 (arrow-up/down)
- 날짜 + 금액 레이블 표시 (예: `24/03`, `14,550원`)
- 매수: 빨간색 (위쪽), 매도: 파란색 (아래쪽)

---

## 데이터 연동 안정성
- yfinance 타임아웃: 60초
- 캐시 TTL: 2시간
- 데이터 검증: None 체크, 최소 10개 데이터 필요
- Fallback 순서: yfinance → FinanceDataReader → pykrx
- KOSPI 지수: yfinance → FinanceDataReader

---

## 변경 이력

### 2025-01-25
- **차트 UI 개선**
  - 매수/매도 마커를 슬림한 화살표로 변경
  - 매수/매도 마커에 날짜(YY/MM)와 금액 표시
  - 개별 백테스트 차트: 기본 3년 범위, rangeslider 스크롤
  - 통합 백테스트 차트: 기본 6년 범위, rangeslider 스크롤
  - 기간 선택 버튼 (1Y/3Y/6Y/전체) 추가
  - X축 월간 눈금 추가 (주요: 6개월, 보조: 1개월)
  - 드래그 줌 비활성화, +/- 버튼으로만 확대/축소
  - 전체 제목/라벨 크기 70% 축소
  - 종목 선택 드롭다운 직접 입력 비활성화 (모바일 키보드 방지)

- **데이터 연동 안정성 개선**
  - yfinance 타임아웃 30초→60초 증가
  - 캐시 TTL 1시간→2시간 증가
  - None 체크 및 최소 데이터 길이 검증 추가
  - timezone 처리 개선
  - KOSPI 지수에 FinanceDataReader fallback 추가

---

## 주의사항
- 본 앱은 학습/참고용이며, 실제 투자 판단에 활용 금지
- 투자 손실에 대한 책임은 본인에게 있음
- 2027년 1월 1일부터 앱 사용 불가
